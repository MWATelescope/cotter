\documentclass[useAMS,usenatbib]{mn2e}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
%\usepackage[font={it},labelfont={bf}]{caption}
%\usepackage{units}
\usepackage{times}
\usepackage{color}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{xspace}
\usepackage{subcaption}

\usepackage{fixltx2e} % fixes placing of image positions

\definecolor{customhdrcolor}{rgb}{0.0,0.0,0.0}
\definecolor{customcitecolor}{rgb}{0.0,0.5,0.75}
\definecolor{customlinkcolor}{rgb}{0.0,0.5,0.75}

\usepackage[colorlinks=true,linkcolor=customlinkcolor,urlcolor=customlinkcolor,citecolor=customcitecolor,pdftex]{hyperref}

\ifpdf\pdfinfo{/Title      (WSClean)
               /Author     (A. R. Offringa et al.)
               /Keywords   (instrumentation: interferometers;methods: observational;techniques: interferometric;radio continuum: general)
        }
\else\usepackage{graphics}\fi

\setlength{\pdfpageheight}{\paperheight}
\setlength{\pdfpagewidth}{\paperwidth}

%\newcommand{\editmark}[1]{#1}
%\newcommand{\editmark}[1]{{\color{red}{\textbf{#1}}}}
\newcommand{\degree}{\ensuremath{^{\circ}}\xspace}

% To make Dutch ``tussenvoegsels'' work correctly in Latex such as ``de Bruyn'', we use this command
% It fixes ordering and uppercases.
% In text, it should be written with uppercase, as in ``De Bruyn''
\DeclareRobustCommand{\TUSSEN}[3]{#2}

\title[WSClean: a fast, generic wide-field imager]{WSClean: an implementation of a fast, generic wide-field imager}

\def\ANU{$^{1}$}
\def\CAASTRO{$^{2}$}
\def\Curtin{$^{3}$}
\def\UWisc{$^{4}$}
\def\MIT{$^{5}$}
\def\SKASA{$^{6}$}
\def\ASU{$^{7}$}
\def\Haystack{$^{8}$}
\def\RRI{$^{9}$}
\def\USydney{$^{10}$}
\def\CfA{$^{11}$}
\def\UW{$^{12}$}
\def\Victoria{$^{13}$}
\def\CASS{$^{14}$}
\def\Tata{$^{15}$}
\def\NRAO{$^{16}$}
\def\UMelbourne{$^{17}$}

\author[A.~R.~Offringa et al.]{A.~R.~Offringa$^{1,2}$\thanks{E-mail: \url{andre.offringa@anu.edu.au}},
B.~McKinley\ANU$^,$\CAASTRO,
N.~Hurley-Walker\Curtin,
F.~H.~Briggs$^{1,2}$, \newauthor
R.~B.~Wayth\Curtin$^,$\CAASTRO, 
D.~L.~Kaplan\UWisc,
M.~E.~Bell\USydney$^,$\CAASTRO,
L.~Feng\MIT,
A.~R.~Neben\MIT,
J.~D.~Hughes\ANU, \newauthor
J.~Rhee\ANU,
G.~Bernardi\SKASA,
J.~D.~Bowman\ASU,
R.~J.~Cappallo\Haystack,
B.~E.~Corey\Haystack, \newauthor
A.~A.~Deshpande\RRI, 
D.~Emrich\Curtin,
B.~M.~Gaensler\USydney$^,$\CAASTRO,
R.~Goeke\MIT,
L.~J.~Greenhill\CfA, \newauthor
B.~J.~Hazelton\UW, 
J.~N.~Hewitt\MIT,
M.~Johnston-Hollitt\Victoria,
J.~C.~Kasper\CfA, \newauthor
E.~Kratzenberg\Haystack, 
C.~J.~Lonsdale\Haystack,
M.~J.~Lynch\Curtin,
S.~R.~McWhirter\Haystack,
D.~A.~Mitchell\CASS$^,$\CAASTRO, \newauthor
M.~F.~Morales\UW, 
E.~Morgan\MIT,
D.~Oberoi\Tata,
S.~M.~Ord\Curtin$^,$\CAASTRO,
T.~Prabu\RRI, 
A.~E.~E.~Rogers\Haystack, \newauthor
D.~A.~Roshi\NRAO, %\footnote{The National Radio Astronomy Observatory is a facility of the National Science Foundation operated under cooperative agreement by Associated Universities, Inc.},
N.~Udaya~Shankar\RRI,
K.~S.~Srivani\RRI,
R.~Subrahmanyan\RRI$^,$\CAASTRO, \newauthor
S.~J.~Tingay\Curtin$^,$\CAASTRO, 
M.~Waterson\Curtin$^,$\ANU,
R.~L.~Webster\UMelbourne$^,$\CAASTRO,
A.~R.~Whitney\Haystack, \newauthor
A.~Williams\Curtin,
C.~L.~Williams\MIT
\\
\ANU{}Research School of Astronomy and Astrophysics, Australian National University, Canberra, ACT 2611, Australia \\
\CAASTRO{}ARC Centre of Excellence for All-sky Astrophysics (CAASTRO), Australian National University, Canberra, ACT 2611, Australia \\
\Curtin{}International Centre for Radio Astronomy Research, Curtin University, Bentley, WA 6102, Australia\\
\UWisc{}Department of Physics, University of Wisconsin--Milwaukee, Milwaukee, WI 53201, USA\\
\MIT{}Kavli Institute for Astrophysics and Space Research, Massachusetts Institute of Technology, Cambridge, MA 02139, USA\\
\SKASA{}Square Kilometre Array South Africa (SKA SA), Cape Town 7405, South Africa\\
\ASU{}School of Earth and Space Exploration, Arizona State University, Tempe, AZ 85287, USA\\
\Haystack{}MIT Haystack Observatory, Westford, MA 01886, USA\\
\RRI{}Raman Research Institute, Bangalore 560080, India\\
\USydney{}Sydney Institute for Astronomy, School of Physics, The University of Sydney, NSW 2006, Australia\\
\CfA{}Harvard-Smithsonian Center for Astrophysics, Cambridge, MA 02138, USA\\
\UW{}Department of Physics, University of Washington, Seattle, WA 98195, USA\\
\Victoria{}School of Chemical \& Physical Sciences, Victoria University of Wellington, Wellington 6140, New Zealand\\
\CASS{}CSIRO Astronomy and Space Science, Marsfield, NSW 2122, Australia\\
\Tata{}National Centre for Radio Astrophysics, Tata Institute for Fundamental Research, Pune 411007, India\\
\NRAO{}National Radio Astronomy Observatory, Charlottesville and Greenbank, USA\\
\UMelbourne{}School of Physics, The University of Melbourne, Parkville, VIC 3010, Australia\\
}

\begin{document}

\date{Accepted TODO. Received TODO; in original form TODO}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\pubyear{2014}

\label{firstpage}
\maketitle

\begin{abstract}
We present a new interferometric imager that uses the $w$-stacking algorithm and can make use of the $w$-snapshot algorithm. The performance dependencies of CASA's $w$-projection and our new imager are analysed and analytical functions are derived that describe the required computing cost for both imagers. On MWA data, we find our new method to be an order of magnitude faster than $w$-projection, as well as being capable of full-sky imaging at full resolution and with full polarization correction.  We predict the computing costs for several other arrays and estimate that our imager is a factor of 2--12 faster, depending on the array configuration. We estimate the computing cost for imaging full SKA1-low observations to be 60 PetaFLOPS with current techniques. We find that combining $w$-stacking with the $w$-snapshot algorithm does not significantly improve computing requirements. The source code of our new imager is publicly released.
\end{abstract}

\begin{keywords}
instrumentation: interferometers -- methods: observational -- techniques: interferometric -- radio continuum: general
\end{keywords}

\section{Introduction}

Observations from non-coplanar interferometric radio telescopes that image large fractions of the sky at once can not be imaged with a two-dimensional fast Fourier transform (FFT). Instead, the imaging algorithm needs to account for the ``$w$-term'' during inversion, which is the term that describes the deviation of the array from a perfect plane \citep{perley-noncoplanar-arrays}. This deviation is amplified for telescopes with wide field of view, making this especially an issue for low-frequency telescopes that by nature are wide-field instruments.

There are several methods to deal with the $w$-term during imaging: faceting \citep{facetting-cornwell}, a three-dimensional Fourier transform \citep{perley-noncoplanar-arrays}, $w$-projection \citep{wprojection-cornwell}, $w$-stacking \citep{ska-memo-regridding-2011} and $w$-snapshots \citep{widefield-imaging-ska-cornwell}.

New generation of wide-field observatories are producing data sets that are orders of magnitude larger than before. Examples of such telescopes include the Murchison Widefield Array (MWA, \citealt{mwa-design-2009}, \citealt{mwa}), the upgraded Jansky Very Large Array (JVLA) and the Low-Frequency Array (LOFAR, \citealt{lofar-2013}). The Common Astronomy Software Applications (CASA, \citealt{casa-2007}, \citealt{casa-2008}) have an efficient implementation of the $w$-projection algorithm, with many available features such as multi-scale clean and spectral-shape fitting during deconvolution. However, at the MWA we have seen that imaging a 2-min snapshot observation at low-elevation can take up to tens of hours with CASA's $w$-projection algorithm. Larger images or higher zenith angles can be impossible to image because the size and number of $w$-kernels become too large to hold in memory.

Another option exists for imaging MWA data: the Real-Time System (RTS, \citealt{rts-mwa}). This has been designed as an efficient calibration and imaging pipeline specifically for MWA data. It can use GPUs to improve efficiency, and uses a $w$-projection kernel during imaging to correct for the $w$-term. The kernel can be kept small, because the data is processed in snapshots. The RTS can not perform deconvolution as of yet.

To reach high dynamic ranges, it can be necessary to deal with direction-dependent effects (DDEs). This is especially true for widefield telescopes. One way to handle DDEs is by using the a-projection technique, which convolves the data during gridding with a kernel that corrects the DDEs \citep{aprojection-2008}.
One such DDE is the effect of the ionosphere. For the MWA it can be assumed that the ionosphere has the same effect on all tiles, because the maximum baseline length is relatively small (2.9~km) and smaller than the typical size of ionospheric structure \citep{lonsdale-calibration-approaches-ionosphere}. This is not the case for LOFAR, making it necessary to correct the direction-dependent ionospheric effects per station before gridding the data. The \texttt{awimager} has been written to perform these corrections, and uses a hybrid of a-projection, $w$-projection and $w$-stacking \citep{awimager-2013}.

Once the Square-Kilometre Array (SKA) begins its operation, the required computational power for wide-field imaging will become an even bigger challenge. \citet{widefield-imaging-ska-cornwell} argues that the $w$-snapshots algorithm is the most efficient approach for the SKA.

In this article, we present a new implementation of a generic wide-field imager that is significantly faster than CASA's $w$-projection implementation, and is able to successfully image any MWA observation. To obtain the increase in speed, the implementation uses the $w$-stacking method for correcting the $w$-terms, optionally combined with a new technique for $w$-snapshot imaging. We named the new imager ``WSClean'', as an abbreviation for ``$w$-Stacking Clean''. Our new imaging implementation, which we believe to be the fastest generic widefield imager available, is publicly released\footnote{The WSClean source code can be found at:\\\url{http://sourceforge.net/p/wsclean}}.

This paper is structured as follows: The $w$-stacking algorithm is described in Sect.~\ref{sec:wstacking}. Details of implementing the $w$-stacking and $w$-snapshots algorithms are described in Sect.~\ref{sec:implementation}. The performance and accuracy will be analysed in Sect.~\ref{sec:analysis}. The conclusions are presented in Sect.~\ref{sec:conclusions}.

\section{The $w$-stacking technique} \label{sec:wstacking}
In this section, we will describe the $w$-stacking algorithm from a mathematical point of view.

An interferometer samples the complex visibility function
\begin{align}\notag
V(u,v,w) = & \iint \frac{A(l,m) I(l,m)}{\sqrt{1-l^2-m^2}} \times \\ \label{eq:visibility-function}
& e^{-2\pi i \left(ul + vm + w(\sqrt{1-l^2-m^2}-1)\right)} dl dm,
\end{align}
where $u,v,w$ is a baseline coordinate in the coordinate system of the array, $A$ is the primary-beam function, $I$ is the sky function and $l,m$ are cosine sky coordinates. We will use $I'(l,m)$ to denote the sky function before primary-beam correction, $I'(l,m)=A(l,m)I(l,m)$. We will not discuss calibration, but assume $V$ has been calibrated before imaging. In the case of a polarized measurement, the symbols become $2\times 2$ matrices and beam correction is more complicated, but without loss of generality we will ignore polarization and treat inversion as a scalar problem. Imaging consists of inverting Eq.~\eqref{eq:visibility-function}, i.e., to find $I'$ from $V$.

For small field of views, the term $\sqrt{1-l^2-m^2}$ is approximately of unit size, making Eq.~\eqref{eq:visibility-function} approximate an ordinary 2-dimensional Fourier transform that can be inverted with an inverse FFT. A common rule is that this is valid when
\begin{equation}\label{eq:when-2d-is-valid}
\forall w,l,m: w\left(\sqrt{1-l^2-m^2}-1\right) \ll 1.
\end{equation}

To derive the $w$-stacking technique, Eq.~\eqref{eq:visibility-function} is rewritten to
\begin{align}\notag
V(u,v,w) = & \iint \frac{I'(l,m) e^{-2\pi i w(\sqrt{1-l^2-m^2}-1)}}{\sqrt{1-l^2-m^2}} \times \\ \notag
& e^{-2\pi i \left(ul + vm\right)} dl dm.
\end{align}
This is an ordinary two-dimensional Fourier transform going from $u,v$ space to $l,m$ space, and can be inverted to get:
% Intermediate step:
%\begin{align}\notag
%\frac{I'(l,m) e^{-2\pi i w(\sqrt{1-l^2-m^2}-1)}}{\sqrt{1-l^2-m^2}} = & \iint V(u,v,w) \times \\ \notag
%& e^{-2\pi i \left(ul + vm\right)} du dv,
%\end{align}
%which can be rewritten to
\begin{align}\notag
\frac{I'(l,m)}{\sqrt{1-l^2-m^2}} = & e^{2\pi i w(\sqrt{1-l^2-m^2}-1)} \iint V(u,v,w) \times \\ \notag
& e^{2\pi i \left(ul + vm\right)} du dv.
\end{align}
Integrating both sides over $w_{\min}$ to $w_{\max}$, the minimum and maximum value of $w$, results in
\begin{align}\notag
\frac{I'(l,m)\left(w_{\max} - w_{\min}\right)}{\sqrt{1-l^2-m^2}} = \int\limits_{w_{\min}}^{w_{\max}} e^{2\pi i w(\sqrt{1-l^2-m^2}-1)} \times \\ \label{eq:wstacking}
\iint V(u,v,w)  e^{2\pi i \left(ul + vm\right)} du dv dw.
\end{align}
The final step is to make the $u,v,w$ parameters discrete, so that the integration over $u$ and $v$ can become an inverse FFT and the integration over $w$ becomes a summation. This shows that the sky function can be reconstructed by i)~gridding samples with equal $w$-value on a uniform grid; ii)~calculating the inverse FFT; iii)~apply the direction-dependent phase shift $e^{2\pi i w(\sqrt{1-l^2-m^2}-1)}$; iv)~repeat this for all $w$-values and add the results together; v)~apply the final scaling.

In practice, the final scaling will be different from $\left(w_{\max} - w_{\min}\right)/\sqrt{1-l^2-m^2}$ suggested by Eq.~\eqref{eq:wstacking}, because the individual $w$-layers will not be completely filled with samples. Therefore, the number of added samples and their weight have to be taken into account. Additionally, it might be required to divide out the effect of a possible convolution kernel, the primary beam and correct for other direction-dependent effects. In XX, YY, LL or RR polarizations, a correlated baseline is the complex conjugate of the reversed baseline, and the relation $V(u,v,w)=\overline{V(-u,-v,-w)}$ holds. The right-hand side of Eq.\eqref{eq:wstacking} with only positive $w$-value samples then becomes the complex conjugate of the one with only negative $w$-values samples. In this case we can therefore calculate the image for $w<0$ from the image with $w>0$. That allows us to set $w_{\min}$ to the minimum absolute $w$-value, which requires two times fewer layers. In any case, the input to the two-dimensional inverse FFT is not generally an Hermitian-symmetric function, and hence the inverse FFT is always performed as a complex-to-complex transform. 

The inverse of imaging, i.e., to calculate the visibility from a model image, can be done by reversing the $w$-stacking algorithm: i)~inverse scale the image; ii)~copy the image to several layers; iii)~inverse apply the direction-dependent phase shift for each layer; iv)~FFT each layer; and v)~sample a required visibility from the correct $w$-layer. We will refer to this operation as prediction.

\subsection{Discretization of $w$} \label{sec:gridding-w}
\begin{figure}
\begin{center}
\includegraphics[width=8cm]{img/aliasing-example-annotated}
\caption{Aliasing artefacts caused by insufficient $w$-layers in a simulated field. WSClean was set to use 12 $w$-layers. The centre of the image is at 10\degree zenith angle, which would normally require $\sim195$ $w$-layers. Sources are 1~Jy (red circles), ghost sources are approximately 0.2~Jy. Each source produces two ghost sources, but because they re-appear after a major cleaning cycle, they are eventually cleaned and produce more ghost sources. }
\label{fig:aliasing-example}
\end{center}
\end{figure}
While the discretization of $u$ and $v$ is similar to conventional imaging, the discretization of $w$ defines the number of $w$-layers that need to be processed. For this, one can use a rule similar to \eqref{eq:when-2d-is-valid}, and make sure that the phase difference for two subsequent discretized $w$-values, $w_A$ and $w_B$,  is less than one radian. This results in the constraint
\begin{equation} \label{eq:minimum-w-distance}
\left|\left(w_A - w_B\right) 2\pi (\sqrt{1-l^2-m^2}-1)\right| \ll 1.
\end{equation}
This suggest that a uniform discretization in $w$ is optimal. This is in contrast to \citet{wprojection-cornwell} where $\sqrt{w}$ tabulation is suggested. From Eq.~\eqref{eq:minimum-w-distance}, the required number of layers can be derived and is given by
\begin{equation} \label{eq:nwlayers-bound}
 N_\textrm{wlayers} \gg 2\pi \left(w_{\max} - w_{\min}\right) \max_{l,m} \left(1 - \sqrt{1-l^2-m^2}\right).
\end{equation}
Actual values for the right-hand side can differ a lot. The value of $w_{\max} - w_{\min}$ is influenced by the coplanarity of the array, the zenith angle and the wavelength, while the value of the $\max_{l,m}$ term is influenced by the angular size of the image. For the MWA, a typical value of $w_{\max} - w_{\min}$ is $\sim 10$ at zenith, but is already $\sim 400$ at a zenith angle of $30^{\circ}$. For a typical full-field-of-view image of a MWA observation of $3072\times 3072$ pixels of $0.75''$ size, the $\max_{l,m}$ term is $0.68$. This implies that tens of $w$-layers are required at zenith and hundreds at lower elevations. The number of $w$-layers has a large effect on the performance of the $w$-stacking algorithm, and will be discussed further in the next sections.

Using too few $w$-layers results in decorrelation of off-axis sources in the longer baselines. Additionally, $w$-aliasing errors can cause ghost sources in the image. An (extreme) example of this effect is shown in Fig.~\ref{fig:aliasing-example}. When Cotton-Schwab cleaning includes prediction with too few $w$-layers, incorrect values will be subtracted from the visibilities even when no aliased sources are cleaned during minor iterations. Therefore, accurate prediction is more important than accurate imaging, because aliasing artefacts are attenuated by cleaning as long as the model is subtracted accurately.

\subsection{Time complexity of $w$-stacking} \label{sec:time-complexity}
It is useful to analyse the time complexity of $w$-stacking and compare it with $w$-projection, to understand which algorithm performs better in a given situation. We will use the following symbols: $N_\textrm{wlay}$ is the number of $w$-layers for $w$-stacking, $N_\textrm{pix}$ is the number of pixels in the image along each side, $N_\textrm{vis}$ is the number of visibilities, $N_\textrm{kern}$ is the size of the anti-aliasing kernel (see \S\ref{sec:gridding}), $N_\textrm{wkern}$ is the size of the $w$-kernel for $w$-projection, $w_{\max}$ is the maximum $w$ value and $\alpha_\textrm{FOV}$ is the imaging field of view.

\begin{table}
 \caption{Scaling of the computational cost for various imaging steps} \label{tbl:computational-cost-per-operation}
 \begin{tabular}{lll}
   \textbf{Operation} & \textbf{$w$-stacking} & \textbf{$w$-projection} \\
   \hline\hline
   Fourier transform(s) & $N_\textrm{wlay} N^2_\textrm{pix} \log N_\textrm{pix}$ & $N^2_\textrm{pix} \log N_\textrm{pix}$ \\
   $w$-term corrections   & $N_\textrm{wlay} N^2_\textrm{pix}$ & $N_\textrm{vis} N^2_\textrm{wkern}$ \\
   Gridding & $N_\textrm{vis}N^2_\textrm{kern}$ & $N_\textrm{vis} N_\textrm{kern}^2$ \\
   \hline\hline
 \end{tabular}
\end{table}

Table~\ref{tbl:computational-cost-per-operation} shows how the computational costs scale for the operations that dominate the imaging in the $w$-stacking and $w$-projection algorithms. For comparison, we can assume the gridding kernel adds a constant term and the terms $N_\textrm{wlay}$ and $N_\textrm{wkern}$ follow approximately $w_{\max} \sin \alpha_\textrm{FOV}$. The time complexity for $w$-stacking is then given by
\begin{equation}
\textrm{TC}_\textrm{wstacking}=\mathcal{O}\left(N^2_\textrm{pix} \log N_\textrm{pix} w_{\max} \sin \alpha_\textrm{FOV}+ N_\textrm{vis} \right),
\end{equation}
and for $w$-projection it is
\begin{equation}
\textrm{TC}_\textrm{wprojection}=\mathcal{O}\left(N^2_\textrm{pix} \log N_\textrm{pix} + N_\textrm{vis} w_{\max}^2 \sin^2 \alpha_\textrm{FOV}\right).
\end{equation}
From these bounds it can be concluded that in the limiting behaviour, the $w$-stacking method will be faster when the gridding of the visibilities is the dominating cost of the algorithm. The $w$-projection algorithm will be faster when the inverse FFTs are dominating. In Sect.~\ref{sec:analysis} we will determine which method is faster in practice for different parameters.

\section{The WSClean imager implementation} \label{sec:implementation}
With the purpose of testing new algorithms for the imaging of MWA data, we have written a new imager around the $w$-stacking algorithm. The imager is not specialized for the MWA, and has been successfully used for imaging data from other telescopes.

The new imager, called ``WSClean'', is written in the C++ language. It reads visibilities from CASA measurement sets and writes output images to Flexible Image Transport System (FITS) files. Several steps are multi-threaded using the threading module of the C++11 standard library. These are: reading and writing; gridding from and to different $w$-layers; performing the FFTs; and H\"ogbom Clean iterations (peak-finding and image subtraction, \citealt{hogbom-clean}). For the latter, intrinsics are used as well. Because of these optimizations, minor Cleaning iterations with an image size of $3072\times3072$ are performed at a rate of hundreds per second. This is fast enough to make the Clark Clean optimization \citep{clark-clean}, which consists of considering only a subset of pixels with a reduced PSF, less relevant. For very large images this optimization might still be useful, but we have not implemented it in WSClean. Because the PSF varies for imaging with non-zero $w$-values, subtracting a constant PSF in image space leads to inaccuracies. After a number of minor iterations, it is therefore beneficial to invert the model back to the visibilities via prediction, and subtract the model directly from the visibilities \citep{wprojection-cornwell}. This is similar to the Cotton-Schwab cleaning method \citep{cotton-schwab-clean}. WSClean allows cleaning individual polarizations, or can jointly deconvolve the polarizations. In the latter case, peaks are searched in $pp^2+2pq \overline{(pq)} + qq^2$ space, where $\overline{pq}=qp$ is the complex conjugate of $pq$, and the PSF is subtracted from the polarizations with different factors.

It will not be possible to store all $w$-layers in memory when creating large images or when many $w$-layers are used. For example, our 32-GB test machine can store 227 $w$-layers of $3072\times3072$ in memory. In more demanding imaging configurations, the implementation performs several passes over the measurement set and will grid a subset of $w$-layers in each pass.

\subsection{Full-sky imaging}

\begin{figure*}
\begin{center}
\includegraphics[width=13.5cm]{img/fullsky-together}
\caption{A beam-corrected MWA image of a 112~s zenith observation that covers almost the full sky. The lower image shows a zoom-in on the southern side lobe. PKS J2358-6054 ($\sim100$ Jy) is visible in the centre of the southern side lobe and resolved. The noise level in the side lobe is about 200 mJy. PKS J2358-6054 has been cleaned, but some artefacts remain because no direction-dependent calibration has been performed.}
\label{fig:full-sky-example}
\end{center}
\end{figure*}

For low-frequency telescopes, it can be of interest to do full-sky (i.e., horizon to horizon) imaging. In the case of MWA, the tile beam can have strong sidelobes at a distance of more than 90\degree from the pointing centre. Imaging these sidelobes might be relevant because they are scientifically of interest (e.g. when searching for transients). Full-sky imaging can also be useful for self-calibration or deconvolution. For example, self-calibration using full-sky clean components has been found to give good results in imaging the resolved FR-II radio source Fornax~A (McKinley et al., in prep.). An example full-sky MWA image is shown in Fig.~\ref{fig:full-sky-example}.

To efficiently image the full sky, an observation is split into short snapshots, their phase centre is changed to zenith and subsequently a suitable area is imaged. Depending on desired resolution and dynamic range, this might require very large images. To make an image at the MWA resolution, the image needs to have approximately 10k pixels along each side. The $w$-values will be very small at zenith, because at zenith only the vertical offsets of the antennas will contribute to the $w$-value. For the 128-tile MWA, the maximum differential elevation between tiles is $8.5$m. The tiles are in fact on a slight slope, and by fitting a plane to the antennas and changing the phase centre towards the normal of that plane, the maximum $w$-value decreases to $5.5\textrm{m} / \lambda$. In the following sections, when discussing the MWA zenith direction we are referring to this optimal $w$-direction.

\subsection{$w$-snapshots} \label{sec:snapshot-imaging}
\begin{figure*}
\begin{center}
\includegraphics[width=8cm]{img/vela-normal-projection}
\includegraphics[width=8cm]{img/vela-zenith-projection}
\caption{13-min MWA observation of supernova remnants Vela and Puppis A. Left: normal projection centred on Puppis A, right: phase-rotated to zenith to reduce $w$-values, recentred on Puppis A during imaging. Both Stokes-I images have been made with WSClean using the Cotton-Schwab clean algorithm. No beam correction was applied. Imaging computing cost was 60 min for the normal projected image and 41 min for the recentred image.}
\label{fig:vela-projection-example}
\end{center}
\end{figure*}
As discussed, all-sky snapshot imaging with zenith as phase centre is quite efficient. However, if one is not interested in imaging the whole sky, and the direction of interest is far from zenith, the computational overhead of making all-sky images is undesirable.

Instead of imaging the whole sky, the image can be recentred from $(l,m)$ to $(\hat{l},\hat{m})=(l+\Delta l,m+\Delta m)$ by performing the substitution $(l,m)\leftarrow(\hat{l},\hat{m})$ in Eq.~\eqref{eq:wstacking}:
\begin{align}\notag
\frac{I'(\hat{l}, \hat{m})\left(w_{\max} - w_{\min}\right)}{\sqrt{1-\hat{l}^2-\hat{m}^2}} = \int\limits_{w_{\min}}^{w_{\max}} e^{2\pi i w(\sqrt{1-\hat{l}^2-\hat{m}^2}-1)} \times \\
\iint e^{2 \pi i \left(u\Delta l + v\Delta m\right)} V(u,v,w) e^{2\pi i \left(ul + vm\right)} du dv dw.
\end{align}
In words, recentering an image involves accounting for the position shift during the $w$-correction and final scaling, and shifting the visibilities in phase by multiplication with $e^{2 \pi i \left(u\Delta l + v\Delta m\right)}$ prior to the imaging. This essentially is a method of implementing the $w$-snapshots algorithm as described by \citet{widefield-imaging-ska-cornwell}. However, instead of creating warped images by performing the FFT over a tilted plane in $uvw$-space, our method transforms planes with constant $w$-values. The benefit of our method is that the resulting image has a circular synthesized beam, i.e., the resolution in $l$ and $m$ directions matches the intrinsic resolution of the instrument, which is desirable for cleaning. Our method is also relatively easy to implement. It has a similar computational cost compared to the $w$-snapshot algorithm, although the required number of $w$-layers has a different dependency on zenith angle, field of view and the non-coplanarity.

By doing the inverse corrections during prediction, a recentred visibility set can be cleaned with Cotton-Schwab iterations similar to a non-recentred set. The PSF used during minor cleaning iterations is created by multiplying the weights with the recentering corrections, such that the PSF represents a source in the middle of the image.

A recentred image is in the projection of the zenith tangent plane, and will need an additional regridding step before multiple snapshots can be added together. A recentred image can be stored in a Flexible Image Transport System (FITS) file with the slant orthographic (SIN) projection normally used in interferometric imaging \citep{fits-coordinates-2002}, by setting the centre of tangent projection with the \texttt{CRPIXi} keyword \citep{wcs-in-fits}. Common viewers such as Kvis and DS9 support such FITS files and display their coordinates correctly. Unlike warped snapshots, recentred images do not need the generalized-SIN-projection keywords \texttt{PV2\_1} and \texttt{PV2\_2}.

An example of the difference in projection between non-recentred and recentred imaging is given in Fig.~\ref{fig:vela-projection-example}, which displays a 13-min MWA observation imaged with WSClean. The processing steps performed for this image were i) preprocessing of the observation with the Cotter preprocessing pipeline, which include time averaging and RFI flagging with the AOFlagger \citep{post-correlation-rfi-classification,scale-invariant-rank-operator}; ii) calibrate on Hydra~A without direction dependence using a custom implementation of the RTS full-polarization calibration algorithm \citep{rts-mwa}; and iii) image each of the seven 112 s intervals separately. Cleaning an image that is in a different projection yields slightly different results, but qualitatively the two images are clearly of equal accuracy. The wall-clock time for imaging is 60 min and 41 min for respectively normal projection and the recentred image. Of the 41 min, 3 min is spent on phase rotating the visibilities.

Another method to shift an image is by using the periodicity of the FFT function. Since sources outside the field of view will be aliased back into the field, the image can be transformed to have the alias in the centre. This complicates gridding during imaging, because the anti-aliasing kernel needs to have a pass-band shape instead of a low-pass shape. Therefore, we chose to implement the former method.

\subsection{Beam correction}
\begin{figure*}
\begin{center}
\includegraphics[width=6cm]{img/pulsar-stokesi}\hspace{1cm}\includegraphics[width=6cm]{img/pulsar-stokesv}
\caption{Stokes I (left panel, total power) and Stokes V (right panel, circular polarization) images of PSR J0437-4715, demonstrating the full-polarization beam correction capability for MWA observations with WSClean. The pulsar (centre of image) displays 17\% circular polarization.}
\label{fig:pulsar-stokes-iv}
\end{center}
\end{figure*}
Because the MWA consists of fixed, beam-formed dipole antennas, the voltage beam of a MWA tile is described by a complex, non-diagonal Jones matrix. Alternatively, Mueller matrices can be used as well, but in general these result in more computations \citep{revisiting-me-i}. When assuming all individual antennas of the tiles are working properly, all tiles have the same beam. The beam can then be corrected in image space for all tiles at once with
\begin{equation}\label{eq:beam-correction}
 I(l, m) = J(l,m)^{-1} I'(l, m) \left(J(l,m)^*\right)^{-1},
\end{equation}
where each term is a $2\times2$ complex matrices, with $J$ the voltage beam and $^*$ denoting the conjugate transpose. Because $J$ is complex and non-diagonal, all 4 combinations of the cross-correlated polarizations $p$ and $q$\footnote{The instrumental polarizations of the MWA are informally often referred to as $X$ and $Y$, mainly because many software treats the two polarizations as such. However, this is somewhat confusing because they are not necessarily orthogonal.} including the imaginary part of the $pq$ and $qp$ are required to calculate any of the Stokes parameters. The $pp$ and $qq$ have no imaginary part due to the $uv$-symmetry. To make proper MWA beam correction possible, WSClean can output both real $pp$, $pq$, $qp$, $qq$ images and imaginary $pq$ and $qp$ images. This requires four runs of the algorithm. Once these images are created, a separate program is used to perform the correction of Eq.~\eqref{eq:beam-correction}. The method is demonstrated in Fig.~\ref{fig:pulsar-stokes-iv}, which displays a detection of pulsar J0437-4715 in Stokes V. The image was made with an initial pipeline for the radio-sky monitor project that uses the MWA to search for transients and exoplanets. The pipeline includes WSClean to make the Stokes-parameter images.

Our image-based beam-correction method avoids expensive beam-correcting kernels during gridding, but only works because all tiles have the same beam. To apply the same method on heterogeneous arrays such as LOFAR, each set of correlations with a different combination of station beams will have to be imaged separately, which will increase the cost of the algorithm excessively unless an a-projection kernel is used. The AWImager uses an intermediate method, and corrects a common dipole factor in image space and the phased-array beam factor in $uv$-space, which allows the gridding kernel to be smaller compared to correcting both in $uv$-space \citep{awimager-2013}.

\subsection{Gridding} \label{sec:gridding}
A gridding convolution kernel improves the accuracy of gridding in $uv$-space. A common kernel function is a windowed sinc function, which acts as a low-pass filter. This decreases the flux of sources outside the field of view, and thus helps to attenuate aliased ghost sources and sidelobes \citep{post-correlation-filtering}. By supersampling, a convolution kernel also makes it possible to place samples more accurately at their $uv$ position, thereby lowering decorrelation.

The prolate spheroidal wave function (PSWF) is generally considered to be the optimal windowing function for gridding \citep{fourier-kernel-selection-1991}. CASA convolves samples with a PSWF of 7 pixels total width during gridding. When using a variable kernel size, a PSWF is quite complicated and computational expensive to calculate. WSClean currently uses a Kaiser-Bessel (KB) window function, which is easy and fast to compute, and is a good approximation of the PSWF \citep{fourier-kernel-selection-1991}. After some benchmarks (see Appendix~\ref{sec:gridding-appendix}) we found that 7 pixels is a good compromise between performance and accuracy, and this is the default for WSClean.

\subsection{Decreasing inversion resolution} \label{sec:decreasing-inversion-resolution}
Typically, for cleaning it is desired that images have a pixel size at least 5 times smaller than the synthesized-beam width. This improves the accuracy of the clean algorithm, because the positions of image maxima will be closer to the actual source positions. This factor of $\sim$5 is normally taken into account in the overall imaging resolution, i.e., the image size is increased during inversion. For the $w$-projection method, the cost of inversion with an increased resolution is small, because it does not increase the size of the $w$-kernels. It will affect the inverse FFT, but the relative cost of this step is negligible in the total cost. The $w$-stacking method is however significant affected by the image resolution, because it performs many inverse FFTs.

The spatial frequencies in the output image are band limited by the synthesized beam. Therefore, it is not required to perform the inversion at higher resolution. As long as the $uv$-plane is sampled with at least the Nyquist frequency, a high resolution image can be perfectly reconstructed from an inversion at lower resolution. After an up-scaled image has been cleaned, a model is created at the same (high) resolution. Because the model consists of delta functions, the spatial frequencies in the model are not band limited. Therefore, downscaling the model will remove information from the model. However, only the low spatial frequencies of this image will be used in the prediction. As long as downscaling does not modify the low-frequency components, the output of the prediction step will not change. This requires low-pass filtering the model before decimation.

We have implemented an option in WSClean to automatically decrease the inversion resolution to the Nyquist limit,
\begin{equation}\label{eq:nyquist-resolution}
 N_\textrm{Nyquist} = 2 \frac{N_\textrm{pix} S_\textrm{pix}}{S_\textrm{synth beam}},
\end{equation}
where $N_\textrm{Nyquist}$ the resolution in pixels used during inversion, $N_\textrm{pix}$ the requested number of pixels of the image along one side, $S_\textrm{pix}$ the requested angular pixel scale and $S_\textrm{synth beam}$ the minimum angular size of the synthesized beam. Before cleaning, the low-resolution image is interpolated with a procedure consisting of i) a low-resolution FFT; ii) zero padding; and iii) a high-resolution inverse FFT. Such interpolation assumes the image to be periodic, but this is already assumed during the inversion process. After cleaning, the model is decimated by the inverse procedure, consisting of i) a high-resolution FFT; ii) truncation; and iii) a low-resolution inverse FFT. With common settings, this procedure decreases the inversion imaging resolution with a factor of 2.5. Without further correction, such a decrease would lower the positional accuracy with which visibilities are gridded onto the $uv$-plane. This can be corrected by increasing the oversampling rate, which has almost no affect on performance.

Recreating Fig.~\ref{fig:vela-projection-example} using both the snapshot method and this optimization lowers the computational cost from 41~min to 24~min. Of the 24~min, 77\% is spent on cleaning approximately 100,000 components. The outputs with and without rescaling do not visibly differ, but have an RMS difference of 20 mJy. We think this can be explained by the non-linear behaviour of clean.

\section{Analysis} \label{sec:analysis}
We will now analyse the performance and accuracy of our implementation, and compare it with the $w$-projection implementation in CASA. For the analysis, we use imaging parameters which are common for MWA Imaging. When a specific parameter value is not mentioned, the settings from Table~\ref{tbl:default-parameters} are used. The number of $w$-projection planes in $w$-projection is kept equal to the number of $w$-layers in $w$-stacking, and is set to the right hand side of Eq.~\eqref{eq:nwlayers-bound}. This yields 195 $w$-planes/layers at 10\degree zenith angle. Several configurations with large $w$-values fail to image with CASA, presumably because the $w$-kernels become to large.

The used software version of CASA is ``stable release 42.0, revision 26465'', which was released September 2013. For WSClean, the latest version as of February 2014 was used. The tests were run on a high-end desktop with 32 GB of memory and a 3.20-GHz Intel Core i7-3930K processor with 6 cores that can perform 138 giga-floating point operations per second (GFLOPS). The data are stored on a multi-disk array with 5 spinning hard disks, which has a combined read rate of about 450 MB/s.
\begin{table}%
\caption{Parameter values used during benchmarks, unless otherwise mentioned.} \label{tbl:default-parameters}%
\begin{center}\begin{tabular}{rl}%
\hline
Array & MWA 128T \\
Image size & $3072 \times 3072$ \\
Angular pixel size & $0.72'$ \\
Number of visibilities & $3.5 \times 10^8$ \\
Time resolution & 2~s \\
Frequency resolution & 40~kHz \\
Observation duration & 112 s\\
Bandwidth & 30.72 MHz (768 channels)\\
Central frequency & 182 MHz \\
Zenith angle at phase centre & 10\degree \\
Max $w$-value for phase centre & 172 $\lambda$ (283 m) \\
Nr. polarizations in set & 4 \\
Imaged polarization & $pp$ ($\sim$XX) \\
Imaging mode & Multi-frequency synthesis \\
Weighting & uniform \\
Data size & 18 GB \\
\hline
\end{tabular}\end{center}\end{table}

\subsection{Accuracy}
\begin{table}%
\caption{Results on imaging accuracy measurements.} \label{tbl:accuracy-measurements}%
\begin{center}\begin{tabular}{lrrr}%
\hline\hline
& \textbf{WSClean} & \textbf{WSClean}    & \textbf{CASA} \\
&                  & \textbf{+ recentre} & \\
\hline
\multicolumn{3}{l}{\textit{Zenith angle 0\degree (6 $w$-layers/planes)}} \\
\hline
Source flux standard error & 1.31\% & & 1.34\% \\
RMS in residual image & 0.94 mJy & --- & 1.90 mJy\\
Computational time & 8.5 min & & 19.3 min\\
\hline
\multicolumn{3}{l}{\textit{Zenith angle 0\degree (128 $w$-layers/planes)}} \\
\hline
Source flux standard error & 1.39\% & & 2.08\% \\
RMS in residual image & 0.94 mJy & --- & 0.94 mJy \\
Computational time & 10.3 min & & 19.6 min \\
\hline
\multicolumn{3}{l}{\textit{Zenith angle 10\degree}} \\
\hline
Source flux standard error & 1.75\% & 1.40\% & 2.41 \%\\
RMS in residual image & 0.90 mJy & 1.03 mJy & 1.07 mJy \\
Computational time & 15.3 min & 6.6 min & 178.2 min \\
\hline\hline
\end{tabular}\end{center}\end{table}

\begin{figure*}
\begin{center}
\includegraphics[height=5cm]{img/residual-casa}\hspace{1cm}\includegraphics[height=5cm]{img/residual-wsclean}
\caption{Residual images after Cotton-Schwab cleaning of a simulated 10\degree-zenith angle MWA observation using CASA (left) and WSClean (right), using similar inversion and cleaning parameters. The panels show a small part of the full images. The full field contains 100 simulated sources over 20\degree. Sources in the image produced with CASA are slightly less accurately subtracted, leading to a residual noise level of 1.07 mJy and some visible artefacts, whereas WSClean reaches 0.90 mJy. Since the effect is stronger away from the phase centre, it is likely that this is caused by the finite size of the $w$-kernels used in $w$-projection, which leads to inaccuracies.}
\label{fig:residuals}
\end{center}
\end{figure*}

To assess the accuracy of WSClean and CASA, we simulate a MWA observation with hundred sources of 1~Jy in a 20\degree diameter area, without adding system noise. A unitary primary beam is assumed. We image the simulated set with WSClean and CASA using Cotton-Schwab cleaning to a threshold of 10~mJy. The two imagers calculate slightly different restoring (synthesized) beams, hence to avoid bias the restoring beams are fixed. Other imaging parameters are given in Table~\ref{tbl:default-parameters}. The Aegean program \citep{aegean-hancock-2012} is used to perform source detection on the produced images. Sidelobe noise of the residual 10~mJy source structures triggers a few false detections. These are ignored.

Table~\ref{tbl:accuracy-measurements} lists the measured RMS in the residual image and the standard errors of the source brightnesses as detected by Aegean. In all tests, WSClean performs slightly more accurate. At zenith, CASA produces a residual RMS twice as high as WSClean. This is caused by the fact that we keep the number of $w$-projection planes in $w$-projection equal to the number of $w$-layers in $w$-stacking, resulting in only 12 $w$-planes at zenith. This evidently has a stronger effect on the $w$-projection algorithm. However, the computational performance of the $w$-projection algorithm is hardly affected by the number of $w$-projection planes, and in practical situations one would always use more $w$-projection planes. When 128 $w$-projection planes are used in CASA, its residual RMS is equal to WSClean with 12 $w$-layers, but the flux density measurements are less accurate. We do not know why this parameter needs to be higher in CASA to reach the same RMS.  Eq.~\eqref{eq:nwlayers-bound} results in $N_\textrm{wlayers}\gg 6$ for the top-left image pixel that is 26\degree away from the centre, while the sources are all within 10\degree. Also unexpected is that the source flux density becomes worse by increasing the number of planes. For WSClean both values stay approximately the same when the number of $w$-layers is increased.

In the $\textrm{ZA}=10\degree$ case, CASA is slightly less accurate. The extra noise can be observed in the produced images, as shown in Fig.~\ref{fig:residuals}. An image with the technique of recentring a zenith phase-centred visibility set, as described in Sect.~\ref{sec:snapshot-imaging}, is also made and analysed. Its accuracy is higher compared to the normal projection, but its residual noise is also higher. The reprojection technique needs on average fewer $w$-layers to reach the same level of accuracy. We have performed tests with and without the optimization of \S\ref{sec:decreasing-inversion-resolution}. They yield identical numbers.

WSClean is faster in all tested cases. Both imagers have performed 5 major iterations for these results, and the inversions and predictions are dominating the computing time. We will look more closely at the difference in performance in the next section.

\begin{figure*}%
\begin{subfigure}{.5\linewidth}%
\includegraphics[width=\linewidth]{img/benchmark-nsamples/nsamples}%
\caption{}\label{fig:timing-nsamples}%
\end{subfigure}%
\hspace{-.05\linewidth}\begin{subfigure}{.5\linewidth}%
\includegraphics[width=\linewidth]{img/benchmark-zenith-angle/za}%
\caption{}\label{fig:timing-zenith-angle}%
\end{subfigure}\\
\begin{subfigure}{.5\linewidth}%
\includegraphics[width=\linewidth]{img/benchmark-resolution/resolution}
\caption{}\label{fig:timing-resolution}%
\end{subfigure}%
\hspace{-.05\linewidth}\begin{subfigure}{.5\linewidth}%
\includegraphics[width=\linewidth]{img/benchmark-channels/channels}
\caption{}\label{fig:timing-channels}%
\end{subfigure}\\
\begin{subfigure}{.5\linewidth}%
\includegraphics[width=\linewidth]{img/benchmark-fov/fov}
\caption{}\label{fig:timing-fov}%
\end{subfigure}%
\caption{Imaging performance as a function of several parameters. Error bars show 5$\sigma$ level. Unfinished lines indicate the imager could not run the specific configuration successfully.}\label{fig:timings}
\end{figure*}

\subsection{Performance analysis}

We measured the performance of the imagers using several MWA data sets. Each specific configuration is run 5 times and standard deviations are calculated. The variations between runs is typically a few seconds. In each benchmark, the wall-clock time is measured that is required to produce the synthesized point-spread function and the image itself. No cleaning or prediction was performed, and the optimization of \S\ref{sec:decreasing-inversion-resolution} is not used. The results are given in Fig.~\ref{fig:timings}.

Panel~\ref{fig:timing-nsamples} shows the dependency on the size of the visibility set. Results for imaging at zenith and 10\degree zenith angle (ZA) are shown. The size of the visibility set was varied by changing the time resolution, which affects the number of visibilities to be gridded without changing the maximum $w$-value. For larger sets, both methods show a linear time dependency on the number of visibilities. This implies that gridding or reading dominates the cost. In that situation, the $w$-stacking implementation is 7.9 times faster at $\textrm{ZA}=10\degree$ and 2.6 times faster at $\textrm{ZA}=0\degree$. With small data volumes, the FFTs start to dominate the cost. This is visible from Fig.~\ref{fig:timing-nsamples} by the flattening towards the left. At that point, WSClean is in both cases approximately 3 times faster. At zenith, the two methods are expected to perform almost identical. The factor of 2-3 difference in Fig.~\ref{fig:timing-nsamples} could be due to different choices in optimizations.

In Panel~\ref{fig:timing-zenith-angle}, the computational cost as function of zenith angle is plotted. It shows that, as expected from \S\ref{sec:time-complexity}, the $w$-projection algorithm is more affected by the increased $w$-values, leading to differences of more than an order of magnitude at zenith angles of $\gtrapprox 20$\degree. Additionally, at higher zenith angles, the $w$-kernels become too large to be able to make images of 3072 pixels or larger. Using the recentering technique with WSClean to decrease the $w$-values makes the computational cost approximately constant. However, the additional time required to rephase and regrid the measurement set makes it only worthwhile for images $\ge3072$ pixels and $\textrm{ZA}\ge15\degree$. This is dependent on the speed of rotating the phase centre and regridding. Our program to change the phase centre is currently not multi-threaded, so its performance might be improvable. Furthermore, the relative cost of changing the phase centre is lower when performing multiple major iterations.

In Panel~\ref{fig:timing-resolution}, the number of pixels in the image is changed without changing the field of view. The performance of $w$-stacking is more affected by the size of the image, but is still significantly faster in making 12.8K images at 0\degree ZA than $w$-projection. Imaging the primary MWA beam requires approximately a resolution of 3k for cleaning. If the small-inversion optimization of \S\ref{sec:decreasing-inversion-resolution} is used, this decreases to about 1.5k. At ZA=10\degree, this saves about a factor of 2 in computing cost. The benefit of the optimization increases with resolution. At 10k resolution, cost is decreased by an order of magnitude.

The cost of spectral imaging, i.e. imaging multiple frequencies, is the cost of making an image from fewer visibilities times the number of desired frequencies. Panel~\ref{fig:timing-channels} shows performance versus the spectral output resolution. As can be expected from the previous results, FFTs become the dominant cost for such small visibility sets, and the number of imaged frequencies affect performance linearly.

As can be seen in Panel~\ref{fig:timing-fov}, the field of view (FOV) has a large affect on performance when imaging off-zenith. This plot was created by varying the size of a pixel in the output image, such that the number of pixels in the image did not change. The FOV is calculated as angle between the left- and right-most pixel in the image. CASA is not able to make off-zenith images larger than $\sim$30\degree, and its imaging cost increases much more rapidly compared to the cost of WSClean, which implies that gridding is the major cost in this scenario. The image recentering technique is clearly beneficial for FOVs larger than $\sim$30\degree, and can even make a difference of an order of magnitude at very large FOVs of $\sim$90\degree.

%It is important to point out that all these measurement were performed by imaging a single polarization. Making full-polarization images with WSClean currently requires four runs. Imaging four Stokes parameters with CASA costs slightly less than four times the time of imaging a single polarization. With the settings of Table~\ref{tbl:default-parameters}, the difference is a factor of $3.5$, and imaging XX and YY together costs $1.9$ times imaging just XX.

\subsection{Derivation of computing cost formulae}
Based on the expected cost terms described in Sec.~\ref{sec:time-complexity}, we derive analytical functions for the CASA and WSClean measurements using least-squares fitting. Several functions with different free parameters were tested, and formulae with minimum amount of parameters are selected that still follow the trend of the measurements and have reasonably small errors. Measurements are weighted with the inverse standard deviation instead of the variance, because we found that the latter results in too much weight on fast configurations, leading to functions that represent the general trend less well. The single outlying measurement for $N_\textrm{pix}=1792$ with CASA in Fig.~\ref{fig:timing-resolution} is removed.

For the WSClean time-cost function $t_\textrm{WSClean}$ we find 
\begin{align}\label{eq:wsclean-computing-cost}
& t_\textrm{WSClean} (w_{\max},N_\textrm{Mvis},N_\textrm{freq},N_\textrm{kpix}) = \\ \notag%
& N_\textrm{freq} \left( 0.452 N_\textrm{kpix}^2 \log_2 N_\textrm{kpix} (w_{\max} + 0.611) + 244 N_\textrm{Mvis} \right)
\end{align}
and for CASA we find
\begin{align}\label{eq:casa-computing-cost}
& t_\textrm{CASA}(w_{\max},N_\textrm{vis},N_\textrm{freq},N_\textrm{pix}) = \\ \notag%
& N_\textrm{freq} \left(1.03 N_\textrm{kpix}^2 \log_2 N_\textrm{kpix} + 5.93 N_\textrm{Mvis} (w_{\max} + 1.71)^2\right) + 172.
\label{eq:casa-computing-cost}%
\end{align}
Parameter $w_{\max}$ is the maximum $w$-value and is estimated with
\begin{equation}\resizebox{0.45\textwidth}{!}{$
 w_{\max} = \frac{1}{\lambda}\left[(D \sin \textrm{ZA} + \Delta z_{\max} \cos \textrm{ZA} + \xi) \left(1.0 - \cos(\frac{1}{2}\textrm{FOV})\right)\right]$},
\end{equation}%
where $D$ is the maximum baseline length, $\Delta z_{\max}$ is the maximum height difference between antennas and $\lambda$ is the wavelength, all in meters, and $\xi$ is an extra parameter for fitting the CASA measurements, $\xi_\textrm{CASA}=28.4$ and $\xi_\textrm{WSClean}=0$. These functions follow the trend of the measurements well, with an absolute error of 14.8\% and 20.7\% for respectively the WSClean and CASA functions.

\subsection{Optimal snapshot duration}
Snapshot imaging, such as the recentring technique described in \S\ref{sec:snapshot-imaging}, can be implemented with either $w$-projection or $w$-stacking. Using the derived formulae, we can estimate the cost of making snapshots with both techniques. Snapshot imaging effectively removes the dependency on ZA from $w_{\max}$. Given the snapshot duration $\Delta \tau_\textrm{snapshot}$ and the total integration time $\Delta \tau_\textrm{total}$, the total time cost of inversion becomes
\begin{equation} \label{eq:snapshot-cost}
t_\textrm{snapshot}(\Delta \tau_\textrm{snapshot}) = \frac{\Delta \tau_\textrm{total}}{\Delta \tau_\textrm{snapshot}} t_\textrm{imaging}(w'_{\max},N'_\textrm{vis},N_\textrm{freq},N_\textrm{pix}),
\end{equation}
with
\begin{equation}
w'_{\max} = \frac{1}{\lambda}\max \Delta z \left(1.0 - \cos(\frac{1}{2}(\textrm{FOV} + \omega_E \Delta \tau_\textrm{snapshot})\right),
\end{equation}
$\omega_E$ the rotational speed of the Earth and $N'_\textrm{vis} = N_\textrm{vis}\frac{\Delta \tau_\textrm{total}}{\tau_\textrm{snapshot}}$. We have excluded the cost of phase shifting the visibilities and gridding. The cost for regridding with simple nearest neighbour or bilinair interpolation is indeed negligible, although more accurate interpolation (e.g. Lanczos interpolation) can be expensive. Also, our current implementation of the phase-changing program does take a non-negligible time, but this implementation is not optimized and can in theory be implemented in a preprocessing pipeline or on the fly during imaging.

Function $t_\textrm{snapshot}$ can be minimized to find the optimal snapshot duration. For WSClean with MWA parameters, we find that this function decreases but no minimum is reached for $\Delta \tau_\textrm{snapshot}<24$~h. Therefore, from a performance perspective, the snapshot duration should be as large as possible. In practise, the beam needs to be corrected on small time scales. A snapshot duration of more than a few minutes is therefore not possible. For $w$-projection in CASA we find an optimal snapshot duration of $\sim2$ min for MWA observations.

\begin{table*}
\caption{Configurations for which the computational cost is predicted.} \label{tbl:computational-cost-configurations}
\begin{tabular}{l|rrrrrrrrrr}
 Configuration&$\lambda$& FOV  & Beams & Ant & Res & $D$ & $\max \Delta z$ & int. t & BW & $\Delta \nu$ \\
          & (m)       & (FWHM)&       &     &     & (km)                       & (m)             & (s)    & (MHz) &  (kHz) \\
\hline
 GLEAM    &  2   & 24.7\degree& 1    & 128 & 2'   & 2.9 & 5 & 2 & 32 & 40 \\
 EMU      & 0.2  & 1\degree   & 30   &  36 & 10''  & 6 & 0.2 &10 & 300 & 20\\
 MSSS low &  5   & 9.8\degree & 5    &  20 & 100'' & 5 & 2  &10 & 16 & 16 \\
 MSSS high&  2   & 3.8\degree & 5    &  40 & 120'' & 5 & 2  &10 & 16 & 16 \\
 LOFAR LBA NL& 5 & 4.9\degree & 1    &  38 &   3'' &180& 20 & 1 & 96 & 1 \\
 AARTFAAC &  5   & 45\degree  & 1    & 288 &  20'  & 0.3& 0.5 & 1 &  7 & 24 \\
 VLSS     & 4.1  & 14\degree  & 1    &  27 &  80'' &11.1& 0.2 &10 & 1.56 & 12.2 \\
 MeerKAT  & 0.2  &  1\degree  & 1    &  64 &   6'' &  8 & 1   & 0.5 & 750  & 50 \\
% SKA1 AA inner&2 &  5\degree  & 1    & 433 &  15'' &0.6& 0.5 &  10 & 250 & 1 \\
 SKA1 AA core&2  &  5\degree  & 1    & 866 &    3' &  3& 5 & 10 & 250 & 1 \\
 SKA1 AA full&2  &  5\degree  & 1    & 911 &   5'' &100& 50 & 0.6& 250 & 1 \\
\end{tabular}
\end{table*}

\begin{table*}
\caption{Predicted computational costs for configurations listed in Table~\ref{tbl:computational-cost-configurations}, based on multi-frequency synthesis with 5 major iterations observing for 1 hour at ZA=20\degree with 1 polarization. Predictions are for $w$-projection with CASA; $w$-stacking with WSClean; $w$-stacked snapshots with WSClean using optimal snapshot duration; and a hybrid between $w$-projection and $w$-stacking using CASA with optimal $\Delta w$. All have approximately equal accuracy.} \label{tbl:computational-cost-predictions}
\begin{tabular}{l|rrrr|rr}
               & \multicolumn{4}{c|}{Predicted computing cost on test computer} & min & best \\
 Configuration & $w$-projection & $w$-stacking & $w$-snapshot & hybrid & computing & FLOPS/float \\
 \hline
 GLEAM    &  65h 25m & 8h 04m &  8h 03m & 14h 10m   & 1.1 TFLOPS & $6.9 \times 10^2$    \\
 EMU      &    5.2 d &  2.9 d &   2.9 d & 4.4 d     & 9.7 TFLOPS & $2.1 \times 10^4$      \\
 MSSS low &  2h 16m  & 0h 57m &  0h 57m & 2h 10m    & 130 GFLOPS & $3.5 \times 10^3$   \\
 MSSS high&  7h 16m  & 3h 52m &  3h 52m & 5h 44m    & 530 GFLOPS & $3.4 \times 10^3$   \\
 LOFAR NL &  50.2 d  &  7.3 d &   7.2 d & 12.9 d    &  24 TFLOPS & $4.5 \times 10^3$ \\
 AARTFAAC &  2.5 d   &  1.2 d &   1.2 d &   2.5 d   & 4.1 TFLOPS & $6.8 \times 10^2$   \\
 VLSS     &  0h 09m  & 0h 01m &  0h 01m &  0h 08m   & 2.2 GFLOPS & $12.1 \times 10^3$     \\
 MeerKAT  &   10.8 d &  6.2 d &   6.2 d &  10.8 d   &  21 TFLOPS & $6.8 \times 10^2$ \\
% SKA1 AA inner&392 d &  228 d &   228 d &   392 d & & $6.8 \times 10^2$   \\
 SKA1 AA core&1581 d &  911 d &   911 d &  1570.8   & 3.0 PFLOPS & $6.8 \times 10^2$ \\
 SKA1 AA full& 643 yr& 48.8 yr & 48.8 yr& 84.1 yr   &  59 PFLOPS & $6.8 \times 10^2$ \\
\end{tabular}
\end{table*}

\subsection{Combination of $w$-projection and $w$-stacking}
To combine the $w$-projection and $w$-stacking algorithms, small $w$-corrections are made before the FFTs using a $w$-correcting kernel and large $w$-terms are corrected after the FFTs by gridding onto several $w$-layers. This allows using small $w$-kernels and limits at the same time the number of FFTs and required memory. The AWImager has been applied like this, which let to better results compared to $w$-projection without $w$-stacking \citep{awimager-2013}. For this scenario, Eq.~\eqref{eq:casa-computing-cost} can be used to determine the optimal number of $w$-layers, or more generally the optimal distance between layers, by assuming that the cost of calculating a single $w$-layer equals the cost of imaging the data set with correspondingly smaller $w_{\max}$ value and smaller $N_\textrm{vis}$. If $\Delta w$ is the distance between $w$-layers, then 
\begin{equation}
t(\Delta w) = \frac{w_{\max}}{\Delta w} t_\textrm{CASA}(w'_{\max},N'_\textrm{vis},N_\textrm{freq},N_\textrm{pix}),
\end{equation}
with $N'_\textrm{vis} = N_\textrm{vis}\frac{\Delta w}{w_{\max}}$ and $w'_{\max} = \Delta w$. For MWA observations, the optimal value for $\Delta w$ is about unity, and improves the speed of $w$-projection with about a factor of four. However, the performance of the hybrid method is still about a factor of two lower than our pure-stacking implementation. This could again be the difference in optimisation choices between CASA and WSClean, but it does show that the effort of implementing a hybrid over pure stacking might not be worthwhile. All configurations except VLSS and GLEAM have optimal values for $\Delta w$ much smaller than one, suggesting all $w$-corrections should be done by stacking instead of projection.

An optimisation suggested by \citet{awimager-2013} is to not grid visibilities with $w$-values larger than some value, because this is where most of the computational cost resides when using $w$-projection, while for LOFAR there is little benefit in gridding these samples. In $w$-stacking, the speed gain associated with this optimisation is less significant. Limiting the $w$-values also lowers the snapshots resolution in one direction significantly, because the long baselines in one direction are no longer gridded, which is often not desirable for the MWA.

\subsection{Estimated computing cost for other telescopes} \label{sec:application-to-nonmwa}
We use the derived functions to estimate the computational cost of the algorithms for configurations of several telescopes. We estimate the cost of imaging an hour of ZA=20\degree data for the following surveys or array configurations: The Galactic and Extragalactic MWA survey (GLEAM); the Evolutionary Map of the Universe (EMU) ASKAP survey \citep{emu-norris-2011}; the low and high bands of the LOFAR Multi-frequency Snapshot Sky Survey (MSSS)\footnote{See \url{https://www.astron.nl/radio-observatory/lofar-msss/lofar-msss}}; all Dutch LOFAR stations \citep{lofar-2013}; the AmsterdamASTRON Radio Transients Facility and Analysis Centre (AARTFAAC) project\footnote{See \url{http://www.aartfaac.org}}; The VLA Low-Frequency Sky Survey (VLSS, \citealt{vlss-2007}); The Meer Karoo Array Telescope (MeerKAT); and the low-frequency phase~1 aperture arrays of the Square-Kilometre Array, with the full core (3~km) and the core+arms configurations \citep{ska-phase1-2013}. The configurations are summarized in Table~\ref{tbl:computational-cost-configurations}. In multi-beam configurations such as the SKA and EMU configurations, we assume each beam is imaged separately, i.e., the FOV of a single beam is used and the computing cost is multiplied with the number of beams. The image size is set to 2 times the FOV width divided by the resolution, as described by Eq.~\ref{eq:nyquist-resolution}. The total required computing power is calculated by multiplying the estimated computing time on our test machine with the performance of the machine (138 GFLOPS).

The results are summarized in Table~\ref{tbl:computational-cost-predictions}. WSClean is in most situations predicted to be 2--3 times faster than CASA. WSClean has the largest benefit on full LOFAR, MWA and the full SKA, where WSClean is respectively 7, 8$\times$ and 12 times faster. The $w$-snapshot method does not improve much over normal WSClean operation in any of the cases, except the VLSS case. We think this is because the VLSS had a modest data rates compared to the other configurations, making the constant cost per $w$-plane/layer stand out. The $w$-snapshot might become more valuable at higher zenith angles. The hybrid method is in all situations approximately a factor of two slower than WSClean.

Imaging the full field of view with the full SKA becomes very expensive due to the high frequency and time resolution, and image resolution of $7.2\textrm{k} \times 7.2$k pixels. This translates to a computing power requirement of $\sim60$ PetaFLOPS.

\section{Conclusions} \label{sec:conclusions}
We have shown that the $w$-stacking algorithm is well suited for imaging MWA observations. The WSClean $w$-stacking implementation is faster than CASA's $w$-projection algorithm in all common MWA imaging configurations, leading up to an order of magnitude difference already at a relatively small zenith angle of $10$\degree. It is also slightly more accurate. For approximately zenith angles $>15\degree$ or field-of-view diameters $>35\degree$, snapshot imaging becomes faster. This can lead to performance improvements of a factor of $3$ for the MWA, but only in the most expensive imaging configurations that are less commonly used. Considering the extra regridding step required, which complicates issues such as calculating the integrated beam shape, recentering snapshots is worthwhile for the MWA only at very low elevations or with large fields of view. Extrapolation of the computing cost predicts that this holds for most arrays, including SKA low. A hybrid between $w$-stacking and $w$-projection does not improve performance over a pure $w$-stacking implementation, but does improve a pure $w$-projection implementation significantly. Our optimization of lowering the image resolution during inversion and prediction increases performance by a factor of 2--10 and has no noticeable effect on the accuracy.

The available SKA computing power is estimated to be around $\sim$100 PetaFLOPS. Extrapolation of our results shows that the current imagers require $3$--$60$ petaFLOPS for SKA1 low alone. It was suggested that $w$-snapshots would improve the imaging speed for the SKA situation \citep{widefield-imaging-ska-cornwell}, but our results show this is not the case when already using the $w$-stacking algorithm. Clearly it remains challenging to perform widefield imaging with acceptable performance, but some optimisations could be made for the SKA. For example, a performance gain of a few factors can be achieved by averaging shorter baselines to their maximum integration time and bandwidth resolution before imaging. Moreover, although longer baselines make the imaging more expensive, it is likely that it is not always required to image the full field of view when using the longest baselines.

Deconvolution is not an issue for achieving low to intermediate dynamic ranges with the MWA. Because of sufficient instantaneous $uv$-coverage and near-confusion snapshot noise level, snapshots can be cleaned individually to deep levels. For example, cleaning to $5\sigma$ level results in a cleaning threshold of approximately 100~mJy in 112~s observations. However, MWA's EoR observations \citep{bowman-science-with-the-mwa-2013} require more advanced deconvolution techniques.

So far, we have corrected the (full-polarization) beam in image space, which is possible because of the homogeneity of the MWA tiles. This is cheap for our current snapshot time of 112s, but this might be infeasible when it is required to calculate the beam on very short time scales. Accurate MWA beam models are still being developed. When beam corrections are required on short time scales, calculating $a$-projection kernels or performing snapshot imaging also becomes more expensive, and it would be interesting to find out where the balance lies between these methods. When only a few thousand components need to be deconvolved, an approach with direct Fourier transforms is accurate and affordable. For wide-field arrays this can be combined with calibration of the direction dependence, e.g. with the SAGECAL \citep{sage-calibration-ii} or RTS peeling \citep{rts-mwa} calibration techniques. This is not possible for fields with diffuse emission or faint point sources when no model is known a-priory.

WSClean is currently not able to perform multi-scale clean. Results of applying CASA's multi-scale clean on MWA data show that especially the Galactic plane is significantly better deconvolved using multi-scale clean, but it is very expensive. Imaging a one-minute observation takes 30 hours of computational time without $w$-projection. We plan to implement some form of multi-scale cleaning in WSClean. It is likely that additional optimizations need to be made to be able to do this with acceptable performance.

By using the $w$-stacking algorithms, some computational cost is transferred from gridding to performing FFTs. WSClean uses the FFTW library for calculating the FFTs \citep{fftw-2005}. Further performance improvement can be made by using one of the available FFT libraries that make use of graphical processing units (GPUs).

\section*{Acknowledgments}
This scientific work makes use of the Murchison Radio-astronomy Observatory, operated by CSIRO. We acknowledge the Wajarri Yamatji people as the traditional owners of the Observatory site. Support for the MWA comes from the U.S. National Science Foundation (grants AST-0457585, PHY-0835713, CAREER-0847753, and AST-0908884), the Australian Research Council (LIEF grants LE0775621 and LE0882938), the U.S. Air Force Office of Scientific Research (grant FA9550-0510247), and the Centre for All-sky Astrophysics (an Australian Research Council Centre of Excellence funded by grant CE110001020). Support is also provided by the Smithsonian Astrophysical Observatory, the MIT School of Science, the Raman Research Institute, the Australian National University, and the Victoria University of Wellington (via grant MED-E1799 from the New Zealand Ministry of Economic Development and an IBM Shared University Research Grant). The Australian Federal government provides additional support via the Commonwealth Scientific and Industrial Research Organisation (CSIRO), National Collaborative Research Infrastructure Strategy, Education Investment Fund, and the Australia India Strategic Research Fund, and Astronomy Australia Limited, under contract to Curtin University. We acknowledge the iVEC Petabyte Data Store, the Initiative in Innovative Computing and the CUDA Center for Excellence sponsored by NVIDIA at Harvard University, and the International Centre for Radio Astronomy Research (ICRAR), a Joint Venture of Curtin University and The University of Western Australia, funded by the Western Australian State government. 
\appendix

\section{Optimal gridding kernel size} \label{sec:gridding-appendix}
\begin{figure}
\begin{center}
\includegraphics[width=8cm]{img/benchmark-kernelsize/kernel}
\caption{Effect of anti-aliasing kernel size on performance.}
\label{fig:timing-kernelsize}
\end{center}
\end{figure}
As discussed in \S\ref{sec:gridding}, WSClean uses a Kaiser-Bessel window against aliasing. The type of window function has no effect on the gridding performance, but the size of the kernel affects gridding performance quadratically. Fig.~\ref{fig:timing-kernelsize} shows that this quadratic relation becomes significant for kernel sizes $\gtrapprox 10$. Decreasing the kernel size to values below $7$ has little effect on performance, because for small kernels the visibility-reading rate is lower than the gridding rate. We have not noticed much benefit of larger kernels except in rare cases where a bright source lies just outside the imaged field of view. Therefore, WSClean uses a default of 7 pixels for the gridding kernel. It can be increased when necessary. Of course, different hardware might give slightly different results because of different reading and calculation performance.

% To make Dutch ``tussenvoegsels'' work correctly in Latex such as ``de Bruyn'', we use this command
% In bibliography, it should be written with lowercase, as in ``de Bruyn''
\DeclareRobustCommand{\TUSSEN}[3]{#3}

\bibliographystyle{mn2e}
\bibliography{references}

\label{lastpage}

\end{document}
